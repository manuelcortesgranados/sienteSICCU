<?xml version='1.0' encoding='UTF-8' ?> 
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:a4j="http://richfaces.org/a4j" xmlns:interkont="http://www.interkont.com/jsf"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:rich="http://richfaces.org/rich"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:m="http://code.google.com/p/gmaps4jsf/" template="/facelets/template_proyecto.xhtml" >

    <ui:define name="head">
        <ui:include src="/includes/google_maps_key.xhtml" />
        <!--
        <script type="text/javascript">
            function fun() {
                var center = map.getCenter();
                var zoom=map.getZoom();
                document.getElementById('fr:txthiden').setAttribute('value', center);
                document.getElementById('fr:txtzoomhiden').setAttribute('value', zoom);

            }
        </script>
        -->
        <script>
            var geocoder = null;
            function nuevoPuntoOnclick() {
                    if(jQuery('.selectForma').val() === '1') {
                    jQuery('.txtlatitudAdress').val('');
                    jQuery('.txtlongitudAdress').val('');
                    address = jQuery('.txtAddress').val();
                        if(address !== '') {
                        geocoder = new GClientGeocoder();
                        if (geocoder) {
                            geocoder.getLatLng(
                                    address,
                                    function(point) {
                                        if (!point) {
                                            alert(address + " no fue encontrada");
                                        } else {
                                            jQuery('.txtlatitudAdress').val(point.y);
                                            jQuery('.txtlongitudAdress').val(point.x);
                                            nuevoPunto();
                                        }
                                    }
                            );
                        }
                    }
                }
                return true;
            }
        </script>
    </ui:define>
    <ui:define name="title">
        <h:outputText value="#{var.ingresarnuevoproyecto} - #{var.ubicacionnewobre}"/>
    </ui:define>
    <ui:define name="menu">
        <ui:include src="/facelets/menu_gestion.xhtml"/>
    </ui:define>

    <ui:define name="body" >
        <table  style="width:100%;" align="center" border="0" cellspacing="8" cellpadding="0">
            <tr>
                <h:form>
                    <td rowspan="6" valign="top" style="height:400px;width: 20%">                       
                        <ui:include src="/facelets/menu_lateral_gestion.xhtml"/>
                        <ui:include src="/facelets/menu_lateral_proyecto.xhtml"/>               
                    </td>
                </h:form>
                <td valign="top" height="35" style="width: 80%">
                    <rich:panel id="pgubicolo" header="#{var.ubicacionproyectocolo}" >
                        <a4j:outputPanel id="panelMapa"  style="width: 100%" >
                            <h:form id="fr">

                                <hr style="background-image:none; height:5px; width: 25px;"/>
                                <h:panelGrid columns="3" >
                                    <interkont:spacer width="385" height="5"/>
                                    <h:outputLabel id="lbllugarproyecto"  value="#{var.zonaubi}" for="combolugarproyecto" />
                                    <h:selectOneMenu id="combolugarproyecto" value="#{Supervisor$IngresarNuevaObra.obranueva.lugarobra.intidlugarobra}"  >
                                        <f:selectItems value="#{Supervisor$IngresarNuevaObra.lugarObra}" />
                                        <a4j:ajax event="valueChange" render="gpLblComuna, gpCmbComuna, gpLblBarrio" />
                                    </h:selectOneMenu>
                                </h:panelGrid>
                                <hr style="background-image:none; height:5px; width: 25px;"/>
                                <rich:collapsiblePanel id="simpleToggleSelecMapa" header="#{var.ubicacionproyectogeogra}"  >

                                    <rich:panel id="gpDirMapa" style="width: 100% !important;">
                                        <h:outputText value="#{var.selevisu} "/>

                                        <m:map id="panelMapa"  width="100%"  height="450px" partiallyTriggered="false" autoReshape="#{Supervisor$IngresarNuevaObra.redibujarmapa}" enableScrollWheelZoom="true"
                                               latitude="#{Supervisor$IngresarNuevaObra.latitudmapa}" longitude="#{Supervisor$IngresarNuevaObra.longitudmapa}" zoom="#{Supervisor$IngresarNuevaObra.zoom}"
                                               jsVariable="map" >
                                            <m:polyline lineWidth="3" hexaColor="#ff0000" geodesic="true" >
                                                <a4j:repeat id="idinvias"  var="point" value="#{Supervisor$EntidadConvenio.listapuntosruta}"  >
                                                    <m:point latitude="#{point.floatlatitud}" longitude="#{point.floatlongitud}"  />
                                                </a4j:repeat>    
                                            </m:polyline>

                                            <a4j:repeat id="repe"  var="marker" value="#{Supervisor$IngresarNuevaObra.listamarcadores}"  >

                                                <m:marker longitude="#{marker.longitude}" latitude="#{marker.latitude}"
                                                          draggable="#{marker.draggable}" id="mkObra"  submitOnValueChange="false"
                                                          valueChangeListener="#{Supervisor$IngresarNuevaObra.cambio}">
                                                    <m:eventListener id="even" eventName="dragend" jsFunction="renderDireccion" />
                                                    <m:icon imageURL="/#{var.versioncobra}/resources/images/pin.png"/>

                                                </m:marker>
                                            </a4j:repeat>
                                            <m:mapControl name="GLargeMapControl" position="G_ANCHOR_BOTTOM_RIGHT"/>
                                            <m:mapControl name="GMenuMapTypeControl" position="G_ANCHOR_TOP_RIGHT"/>


                                        </m:map>
                                        <h:inputHidden id="txthiden" value="#{Supervisor$IngresarNuevaObra.jsVariable}" />
                                        <h:inputHidden id="txtzoomhiden" value="#{Supervisor$IngresarNuevaObra.jsZoon}" />
                                        <a4j:jsFunction name="renderDireccion" render="gpDirMapa,layoutLugar,panelMapa,pgubicolo" execute="false" />
                                        <a4j:jsFunction name="funmapCapturaLatLon" onbeforedomupdate="fun()" >
                                            <a4j:ajax event="complete" listener="#{Supervisor$IngresarNuevaObra.capturaZoom}" />
                                        </a4j:jsFunction>
                                        <interkont:spacer width="10"/>
                                        <h:panelGrid id="gpOpMapa">

                                            <a4j:commandButton value="#{var.nuevopunto}" styleClass="txt_header_outtext" rendered="#{Supervisor$EntidadConvenio.intentidadconvenio!=2 and Supervisor$EntidadConvenio.intentidadconvenio!=1 and !Supervisor$IngresarNuevaObra.verNuevo}"
                                                               render="gpOpMapa"  action="#{Supervisor$IngresarNuevaObra.habilitarNuevo}"  >

                                            </a4j:commandButton>
                                            <h:panelGroup id="gpOpcionesMapa" rendered="#{Supervisor$IngresarNuevaObra.verNuevo}">
                                                <h:panelGroup rendered="#{!Supervisor$IngresarNuevaObra.verConfirmar}">
                                                    <h:panelGrid  columns="2">
                                                        <h:outputText id="otSelforma" styleClass="txt_header_outtext" value="Forma de ubicación:"/>
                                                        <h:selectOneMenu id="selectForma" styleClass="selectForma" value="#{Supervisor$IngresarNuevaObra.formaseleccionada}">
                                                            <f:selectItem itemLabel="Arrastrando y soltando" itemValue="0" />
                                                            <f:selectItem itemLabel="Ubicar por dirección" itemValue="1"/>
                                                            <f:selectItem itemLabel="Ubicar por latitud y longitud" itemValue="2"/>
                                                            <a4j:ajax event="valueChange" render="gpFormaSel"/>
                                                        </h:selectOneMenu>
                                                        <h:outputText id="otSelTipo" styleClass="txt_header_outtext" value="Tipo de punto:"/>
                                                        <h:selectOneMenu value="#{Supervisor$IngresarNuevaObra.tiposelec}">
                                                            <f:selectItem itemLabel="Primario" itemValue="0" itemDisabled="#{!Supervisor$IngresarNuevaObra.verPrimario}"/>
                                                            <f:selectItem itemLabel="Secundario" itemValue="1"/>
                                                        </h:selectOneMenu>
                                                    </h:panelGrid>
                                                    <h:panelGroup id="gpFormaSel">

                                                        <h:panelGrid columns="2" rendered="#{Supervisor$IngresarNuevaObra.formaseleccionada==1}">
                                                            <h:outputText id="txtbus" styleClass="txt_header_outtext" value="#{var.ingresedir}"/>
                                                            <h:inputText id="txtAddress" styleClass="txtAddress" value="#{Supervisor$IngresarNuevaObra.address}"/>
                                                            <h:panelGroup style="display:none;" layout="block" >
                                                                <h:outputLabel value="#{var.latitud}:" styleClass="txt_header_outtext"  />
                                                                <h:inputText id="txtlatitudAdress" styleClass="txtlatitudAdress" value="#{Supervisor$IngresarNuevaObra.latNewmanu}"/>
                                                                <h:outputLabel value="#{var.longitud}:" styleClass="txt_header_outtext" />
                                                                <h:inputText id="txtlongitudAdress" styleClass="txtlongitudAdress" value="#{Supervisor$IngresarNuevaObra.longNewmanu}"/>
                                                            </h:panelGroup>
                                                            <rich:hotKey id="myKey" key="return" onkeyup="#{rich:element('newpunto')}.click()" selector="#txtAddress" />
                                                        </h:panelGrid>
                                                        <h:panelGrid columns="2" rendered="#{Supervisor$IngresarNuevaObra.formaseleccionada==2}">


                                                            <h:outputLabel value="#{var.latitud}" styleClass="txt_header_outtext"  />
                                                            <h:inputText id="txtlatmanu"   value="#{Supervisor$IngresarNuevaObra.latNewmanu}"  >
                                                            </h:inputText>
                                                            <h:outputLabel value="#{var.longitud}" styleClass="txt_header_outtext" />
                                                            <h:inputText id="txtlonmanu" value="#{Supervisor$IngresarNuevaObra.longNewmanu}"   />

                                                        </h:panelGrid>
                                                        <h:panelGrid >
                                                            <a4j:commandButton styleClass="newpunto" value="#{var.agregarmarcador}" action="#{Supervisor$IngresarNuevaObra.nuevoPunto}" render="gpDirMapa,layoutLugar" onclick="nuevoPuntoOnclick();" rendered="#{Supervisor$IngresarNuevaObra.formaseleccionada!=1}"/>
                                                            <a4j:commandButton styleClass="newpunto" value="#{var.agregarmarcador}" onclick="return nuevoPuntoOnclick();" rendered="#{Supervisor$IngresarNuevaObra.formaseleccionada==1}"/>
                                                        </h:panelGrid>
                                                    </h:panelGroup>
                                                </h:panelGroup>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{Supervisor$IngresarNuevaObra.verConfirmar}">
                                                <a4j:commandButton value="#{var.confirmarpunto}" id="confpunto" styleClass="txt_header_outtext" action="#{Supervisor$IngresarNuevaObra.confirmarPunto}"
                                                                   render="layoutLugar,gpDirMapa">
                                                </a4j:commandButton>
                                                <a4j:commandButton value="#{var.cancelarpunto}" id="cancpunto" styleClass="txt_header_outtext" action="#{Supervisor$IngresarNuevaObra.cancelarDireccion}"
                                                                   render="layoutLugar,gpDirMapa">
                                                </a4j:commandButton>
                                                <rich:hotKey id="Keyconf" key="return" onkeyup="#{rich:element('confpunto')}.click();" selector="#txtAddress" />
                                            </h:panelGroup>
                                        </h:panelGrid>
                                        <h:panelGroup id="layoutLugar" >


                                            <rich:dataTable id="datamarkers" 
                                                            rows="4" 
                                                            style="text-align:left; width:100%;"
                                                            rowKeyVar="filaSeleccionada"
                                                            var="lalo" value="#{Supervisor$IngresarNuevaObra.marli}" >
                                                <rich:column id="co1" style="width: 100px;"
                                                             >
                                                    <f:facet name="header">
                                                        <h:outputText value="#{var.longitud}" />
                                                    </f:facet>
                                                    <h:outputText id="otxt-la" value="#{lalo.longitude}"/>
                                                </rich:column>
                                                <rich:column id="co2" style="width: 100px;"
                                                             >
                                                    <f:facet name="header">
                                                        <h:outputText value="#{var.latitud}" />
                                                    </f:facet>
                                                    <h:outputText id="otxt-lo" value="#{lalo.latitude}"/>
                                                </rich:column>
                                                <rich:column id="co3" style="width: 100px;"
                                                             >s
                                                    <f:facet name="header">
                                                        <h:outputText value="Direccion" />
                                                    </f:facet>
                                                    <h:outputText id="otxt-di" value="#{lalo.address}"/>
                                                </rich:column>
                                                <rich:column id="co5" style="width: 300px;"
                                                             >
                                                    <f:facet name="header">
                                                        <h:outputText value="Tipo" />
                                                    </f:facet>
                                                    <h:outputText  value="Primario" rendered="#{lalo.tipo==0}"/>
                                                    <h:outputText  value="Secundario" rendered="#{lalo.tipo==1}"/>
                                                </rich:column>
                                                <rich:column id="co4" style="width: 300px;"
                                                             >
                                                    <f:facet name="header">
                                                        <h:outputText value="#{var.eliminar}" />
                                                    </f:facet>
                                                    <a4j:commandLink value="#{var.eliminar}" action="#{Supervisor$IngresarNuevaObra.eliminarMarker(filaSeleccionada)}" render="datamarkers,layoutLugar,gpDirMapa, gpOpMapa"/>
                                                </rich:column>
                                                <f:facet name="footer">
                                                    <rich:dataScroller id="dsmar" for="datamarkers"/>
                                                </f:facet>
                                            </rich:dataTable>

                                        </h:panelGroup>

                                    </rich:panel>

                                </rich:collapsiblePanel>
                                <rich:collapsiblePanel id="simpleToggleSelecLocalidad" header="#{var.relaccioneloca}" switchType="ajax" expanded="true">
                                    <rich:panel id="gpDirLocalidades3" rendered="#{var.habilitarLocalidadesEjecutaraPoryecto}">
                                        <h:panelGrid columns="4">
                                            <interkont:spacer width="385" height="5"/>
                                            <h:panelGrid styleClass="vineta"/>
                                            <h:outputLabel id="lblclasificacionProyecto"  value="#{var.clasificacionProyecto}" for="comboclasificacionproyecto">
                                            </h:outputLabel>

                                            <h:selectOneMenu id="comboclasificacionproyecto" value="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen}" disabled="#{Supervisor$IngresarNuevaObra.tipoOrigenSoloLectura}">
                                                <f:selectItems value="#{Supervisor$IngresarNuevaObra.tipoOrigenes}" />
                                                <a4j:ajax event="valueChange" execute="@this"  render="panelLocalidadProyecto" listener="#{Supervisor$IngresarNuevaObra.ingresaraModalLocalidad}" />
                                            </h:selectOneMenu>
                                        </h:panelGrid>
                                    </rich:panel>

                                    <rich:panel id="panelLocalidadProyecto" >
                                        <rich:panel rendered="#{var.habilitarLocalidadesEjecutaraPoryecto}" >
                                            <h:panelGroup id="paneldeptomuniproyecto" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen!=4}">
                                                <h:panelGroup id="gpdeptomuniproyecto" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==2 || Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==1}">
                                                    <h:panelGrid columns="4">
                                                        <interkont:spacer width="385" height="5"/>
                                                        <h:panelGrid styleClass="vineta"/>
                                                        <h:outputLabel id="lbldepartamentoProyecto"  value="#{var.departamentoProyecto}" for="combodepartamentoproyecto">
                                                        </h:outputLabel>

                                                        <h:selectOneMenu id="combodepartamentoproyecto" disabled="#{var.habilitarDepartamentoEjecutaraProyecto}" value="#{Supervisor$IngresarNuevaObra.codDepartamento}" >
                                                            <f:selectItems value="#{Supervisor$IngresarNuevaObra.departamento}" />
                                                            <a4j:ajax execute="@this, combodepartamentoproyecto" event="valueChange" listener="#{Supervisor$IngresarNuevaObra.llenarMunicipio}"
                                                                      render="panelmunipioproyecto" />
                                                        </h:selectOneMenu>
                                                    </h:panelGrid>
                                                </h:panelGroup>
                                                <a4j:outputPanel id="panelmunipioproyecto" ajaxRendered="true" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==1}">
                                                    <h:panelGrid columns="4">
                                                        <h:panelGrid styleClass="vineta"/>
                                                        <interkont:spacer width="385" height="15"/>
                                                        <h:outputLabel id="lblmunicipioProyecto"  value="#{var.municipioProyecto}" for="combomunicipioproyecto">
                                                        </h:outputLabel>
                                                        <h:selectOneMenu id="combomunicipioproyecto" value="#{Supervisor$IngresarNuevaObra.codMunicipio}">
                                                            <f:selectItems value="#{Supervisor$IngresarNuevaObra.municipio}"/>
                                                        </h:selectOneMenu>
                                                    </h:panelGrid>
                                                </a4j:outputPanel >
                                                <h:panelGroup id="gpregionproyecto" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==3}">
                                                    <h:panelGrid columns="4">
                                                        <interkont:spacer width="385" height="5"/>
                                                        <h:panelGrid styleClass="vineta"/>
                                                        <h:outputLabel id="lblregionProyecto"  value="#{var.regionProyecto}" for="comboregion">

                                                        </h:outputLabel>
                                                        <h:panelGroup id="gpregion">
                                                            <h:selectOneMenu id="comboregion" value="#{Supervisor$IngresarNuevaObra.codRegion}">
                                                                <f:selectItems value="#{Supervisor$IngresarNuevaObra.region}"/>
                                                            </h:selectOneMenu>
                                                        </h:panelGroup>
                                                    </h:panelGrid>
                                                </h:panelGroup>
                                                <h:panelGrid columns="2">
                                                    <interkont:spacer width="485" height="5"/>
                                                    <a4j:commandButton  action="#{Supervisor$IngresarNuevaObra.agregarLocalidad}" render="layoutLocalidades" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen!=4}"
                                                                        value="#{var.agregar}" execute=" @this, combodepartamentoproyecto,combomunicipioproyecto,comboregion"
                                                                        style="font-size:12px;" disabled="#{Supervisor$IngresarNuevaObra.objeto}"/>
                                                </h:panelGrid>
                                            </h:panelGroup>  
                                        </rich:panel>  
                                        <center>
                                            <rich:panel id="layoutLocalidades" header="#{var.localidades}" styleClass="rich-panel-body" style="padding:0px;" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen!=4}">
                                                <h:panelGroup style="overflow:auto; height: 180px; width: 520px">
                                                    <rich:dataTable id="tablaLocalidades" rows="4" var ="_localidad" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==2 || Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==1}"
                                                                    onrowmouseout="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'"
                                                                    onrowmouseover="this.style.backgroundColor='#B4DDEC'" sortMode="single"   binding="#{Supervisor$IngresarNuevaObra.tablalocalidades}"
                                                                    value="#{Supervisor$IngresarNuevaObra.listaLocalidades}" style="text-align:center; width:100%;;">
                                                        <f:facet name="header">
                                                            <rich:columnGroup>
                                                                <rich:column width="150px">
                                                                    <h:outputText value="#{var.codigoLocalidad}"/>
                                                                </rich:column>
                                                                <rich:column width="150px">
                                                                    <h:outputText value="#{var.departamento}" />
                                                                </rich:column>
                                                                <rich:column width="150px" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==1}">
                                                                    <h:outputText value="#{var.municipio}"/>
                                                                </rich:column>
                                                                <rich:column width="100px">
                                                                    <h:outputText value="#{var.eliminar}"/>
                                                                </rich:column>
                                                            </rich:columnGroup>
                                                        </f:facet>
                                                        <rich:columnGroup id="Cuerpo">
                                                            <rich:column  width="150px" >
                                                                <h:outputText value="#{_localidad.strcodigolocalidad}"/>
                                                            </rich:column>
                                                            <rich:column  width="150px" >
                                                                <h:outputText value="#{_localidad.strdepartamento}"/>
                                                            </rich:column>
                                                            <rich:column  width="150px" rendered="#{Supervisor$IngresarNuevaObra.obranueva.tipoorigen.intidtipoorigen==1}">
                                                                <h:outputText value="#{_localidad.strmunicipio}"/>
                                                            </rich:column>

                                                            <rich:column id="Eliminar" width="100">
                                                                <a4j:commandButton id="btEliminar1" rendered="#{var.habilitarLocalidadesEjecutaraPoryecto}" disabled="#{Supervisor$IngresarNuevaObra.objeto}" value="#{var.eliminar}" action="#{Supervisor$IngresarNuevaObra.eliminarLocalidad}" render="layoutLocalidades"/>
                                                            </rich:column>
                                                        </rich:columnGroup>
                                                        <f:facet name="footer">
                                                            <rich:columnGroup >
                                                                <rich:column colspan="4">
                                                                    <rich:dataScroller id="dsLocalidades" for="tablaLocalidades" render="tablaLocalidades"/>
                                                                </rich:column>
                                                            </rich:columnGroup>
                                                        </f:facet>
                                                    </rich:dataTable>

                                                </h:panelGroup>
                                            </rich:panel>
                                        </center>

                                    </rich:panel>
                                </rich:collapsiblePanel>
                                <h:panelGroup >
                                    <h:commandButton id="btVolverDatosBas"  value="#{var.volver}" immediate="true"
                                                     action="datosbasicosnuevoproyecto" />
                                    <h:commandButton value="#{var.continuar}"  action="#{Supervisor$IngresarNuevaObra.pasoGenerarCronograma}" />
                                    <h:commandButton id="btCancelarUbica"  value="#{var.cancelar}" immediate="true"
                                                     action="#{Supervisor$IngresarNuevaObra.cancelar_action}" >
                                    </h:commandButton>

                                    <a4j:outputPanel id="panelErrorUb">
                                        <rich:messages id="messagesUb" globalOnly="true"
                                                       styleClass="mensajes_error_background mensajes_error" ajaxRendered="true"
                                                       >
                                            <f:facet name="infoMarker">
                                                <h:graphicImage height="20px" width="20px" url="/resources/imgs/msginfo.png" />
                                            </f:facet>
                                            <f:facet name="warnMarker">
                                                <h:graphicImage height="10px" width="20px" url="/resources/imgs/msgwarn.png" />
                                            </f:facet>
                                            <f:facet name="errorMarker">
                                                <h:graphicImage height="20px" width="20px" url="/resources/imgs/msgerror.png" />
                                            </f:facet>
                                            <f:facet name="fatalMarker">
                                                <h:graphicImage  height="20px" width="20px" url="/resources/imgs/msgerror.png" />
                                            </f:facet>
                                        </rich:messages>

                                    </a4j:outputPanel>
                                </h:panelGroup>
                                <a4j:jsFunction name="nuevoPunto" action="#{Supervisor$IngresarNuevaObra.nuevoPunto}" render="gpDirMapa,layoutLugar" >
                                </a4j:jsFunction>
                            </h:form>
                        </a4j:outputPanel>
                    </rich:panel>
                </td>
            </tr>
        </table>
    </ui:define> 
</ui:composition>
